<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Ular Ulat + Deteksi Tangan</title>
  <style>
    html,body { margin:0; height:100%; overflow:hidden; background:#000; }
    #video { position:fixed; top:0; left:0; width:100%; height:50vh; object-fit:cover; z-index:0; }
    canvas { position:absolute; top:0; left:0; width:100%; height:100vh; touch-action:none; z-index:1; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="c"></canvas>

  <!-- TFJS Hand-Pose-Detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>

<script>
(async ()=>{
  const video = document.getElementById('video');
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;

  // Atur ukuran canvas
  function resize() {
    canvas.width = innerWidth * DPR;
    canvas.height = innerHeight * DPR;
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  window.addEventListener('resize', resize);
  resize();

  // Mulai kamera
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  } catch(err) {
    alert("Gagal akses kamera: " + err);
    return;
  }

  // Siapkan hand-pose detector
  const detector = await handPoseDetection.createDetector(
    handPoseDetection.SupportedModels.MediaPipeHands,
    { runtime: 'tfjs', modelType: 'lite', maxHands: 1 }
  );

  // Data ular
  const pointer = { x: innerWidth/2, y: innerHeight/2, active: false };
  const segCount = 60, speed = 10;
  let segments = Array.from({length:segCount}, (_,i)=>({x:innerWidth/2 - i*6, y:innerHeight/2}));

  function frame() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height * 0.5);

    detector.estimateHands(video).then(hands=>{
      if(hands.length>0) {
        const keypoints = hands[0].keypoints; 
        const idx = keypoints.find(p=>p.name==='index_finger_tip');
        pointer.x = idx.x; pointer.y = idx.y;
        pointer.active = true;
      } else pointer.active = false;

      // Update ular
      const head = segments[0];
      if(pointer.active){
        const dx = pointer.x - head.x, dy = pointer.y - head.y;
        const d = Math.hypot(dx,dy)||1;
        head.x += dx/d * speed;
        head.y += dy/d * speed;
      }
      for(let i=1;i<segments.length;i++){
        const prev = segments[i-1], cur = segments[i];
        const dx = prev.x-cur.x, dy = prev.y-cur.y;
        const d = Math.hypot(dx,dy)||1;
        cur.x = prev.x - (dx/d)*8;
        cur.y = prev.y - (dy/d)*8;
      }

      ctx.fillStyle = 'cyan';
      segments.forEach(p=>ctx.beginPath(), ctx.arc(p.x,p.y,8,0,2*Math.PI), ctx.fill());

      requestAnimationFrame(frame);
    });
  }

  frame();
})();
</script>
</body>
</html>